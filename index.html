<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ”¤è²©POSç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-5xl mx-auto grid grid-cols-3 gap-4">
    <!-- å•†å“å€ -->
    <div class="col-span-2 grid grid-cols-6 gap-2">
      <!-- å•†å“æŒ‰éˆ•å°‡ç”±JSå‹•æ…‹ç”¢ç”Ÿ -->
    </div>

    <!-- è³¼ç‰©æ¸…å–®å€ -->
    <div class="bg-white shadow-lg rounded-xl p-4 flex flex-col">
      <h2 class="text-xl font-bold mb-2">è³¼ç‰©æ¸…å–®</h2>
      <ul id="cart" class="flex-1 overflow-y-auto mb-2 border p-2 rounded"></ul>
      <div class="text-right text-lg font-bold mb-4">ç¸½é‡‘é¡ï¼š<span id="total">0</span> å…ƒ</div>
      <button id="cashBtn" class="bg-green-500 hover:bg-green-600 text-white py-2 rounded mb-2">ğŸ’µ ç¾é‡‘çµå¸³</button>
      <button id="linePayBtn" class="bg-blue-500 hover:bg-blue-600 text-white py-2 rounded">ğŸ’š LINE Pay</button>
    </div>
  </div>

  <script>
    // ğŸ§© è¨­å®šä½ çš„ Google Apps Script URL
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbyf8hxhEbzKsfihMr9QoIQL4WKfy541oakSscN8t7_F-pAKfS_Hgx_YH9F3FTH3n09P/exec";

    // å•†å“è³‡æ–™ï¼ˆå¯è‡ªè¡Œä¿®æ”¹ï¼‰
    const products = [
      { name: "ç´…è˜¿è””ğŸ¥•é«®å¤¾", price: 30 }, { name: "èŠ±æœµğŸŒ¼é«®å¤¾", price: 35 }, { name: "å¤ªé™½èŠ±ğŸŒé«®å¤¾", price: 35 },
      { name: "å†°æ·‡æ·‹ğŸ¦é«®å¤¾", price: 35 }, { name: "æ³¡èŠ™èŠ±æœµğŸŒ¸é«®å¤¾", price: 35 }, { name: "(--)", price: 10 },
      { name: "æ‰‹æ©Ÿç¹© å°æ¢", price: 70 }, { name: "æ‰‹æ©Ÿç¹© å¤§æ¢", price: 15 }, { name: "(--)", price: 20 },
      { name: "(--)", price: 30 }, { name: "(--)", price: 50 }, { name: "(--)", price: 60 },
      { name: "æ¯å¢Šç›†æ ½", price: 380 }, { name: "æ’èŠ± é¬±é‡‘é¦™ğŸŒ·", price: 180 }, { name: "(--)", price: 30 },
      { name: "(--)", price: 20 }, { name: "(--)", price: 20 }, { name: "(--)", price: 20 },
      { name: "é‰¤ç¹”èŠ±ç±ƒ å°", price: 680 }, { name: "é‰¤ç¹”èŠ±ç±ƒ å¤§ (ç´”èŠ±)", price: 890 }, 
      { name: "é‰¤ç¹”èŠ±ç±ƒ å¤§ (èŠ±èˆ‡å¨ƒå¨ƒ)", price: 920 }, { name: "(--)", price: 45 }, 
      { name: "(--)", price: 60 }, { name: "(--)", price: 20 },
      { name: "é£¯ç³°", price: 35 }, { name: "(--)", price: 20 }, { name: "(--)", price: 25 },
      { name: "è›‹é¤…", price: 35 }, { name: "(--)", price: 30 }, { name: "(--)", price: 40 },
      { name: "é¥…é ­", price: 15 }, { name: "(--)", price: 20 }, { name: "(--)", price: 20 },
      { name: "è±†æ¼¿ç´…èŒ¶", price: 25 }, { name: "(--)", price: 45 }, { name: "(è‡ªè¨‚é‡‘é¡)", price: 0 }
    ];

    const productContainer = document.querySelector('.grid-cols-6');
    const cartEl = document.getElementById('cart');
    const totalEl = document.getElementById('total');

    let cart = [];
    let total = 0;

    // å»ºç«‹å•†å“æŒ‰éˆ•
    products.forEach((p) => {
      const btn = document.createElement('button');
      btn.textContent = `${p.name}\n$${p.price || ''}`;
      btn.className = "text-center text-sm font-bold rounded-lg p-2 h-20 whitespace-pre-line";

      // åˆ¤æ–·æ˜¯å¦ç‚ºç¦ç”¨é …
      if (p.name === "(--)") {
        btn.classList.add("bg-gray-300", "text-gray-500", "cursor-not-allowed");
        btn.disabled = true;
      } else if (p.name === "(è‡ªè¨‚é‡‘é¡)") {
        btn.classList.add("bg-pink-200", "hover:bg-pink-300");
        btn.onclick = () => {
          const custom = prompt("è«‹è¼¸å…¥é‡‘é¡ï¼š");
          const price = parseInt(custom);
          if (!isNaN(price) && price > 0) {
            addToCart({ name: "è‡ªè¨‚é‡‘é¡", price });
          }
        };
      } else {
        btn.classList.add("bg-yellow-200", "hover:bg-yellow-300");
        btn.onclick = () => addToCart(p);
      }
      productContainer.appendChild(btn);
    });

    function addToCart(product) {
      cart.push(product);
      total += product.price;
      renderCart();
    }

    function renderCart() {
      cartEl.innerHTML = '';
      cart.forEach((item, i) => {
        const li = document.createElement('li');
        li.textContent = `${item.name} - $${item.price}`;
        li.className = "flex justify-between border-b cursor-pointer hover:bg-red-50";
        li.onclick = () => removeFromCart(i);
        cartEl.appendChild(li);
      });
      totalEl.textContent = total;
    }

    function removeFromCart(index) {
      total -= cart[index].price;
      cart.splice(index, 1);
      renderCart();
    }

   async function checkout(paymentType) {
      if (cart.length === 0) return alert('è«‹å…ˆé¸æ“‡å•†å“');
      const txnId = 'TXN' + Date.now();
      
      let amountPaid = total; // é è¨­æ”¯ä»˜é‡‘é¡ç­‰æ–¼ç¸½é‡‘é¡
      let change = 0; // é è¨­æ‰¾é›¶ç‚º 0

      if (paymentType === 'Cash') {
        const paidStr = prompt(`è«‹è¼¸å…¥æ”¶åˆ°çš„ç¾é‡‘é‡‘é¡ (ç¸½é¡ $${total})ï¼š`);
        if (paidStr === null) return; // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ

        const paid = parseInt(paidStr);

        if (isNaN(paid) || paid < total) {
          return alert('ç„¡æ•ˆçš„é‡‘é¡æˆ–æ”¯ä»˜é‡‘é¡ä¸è¶³ï¼Œè«‹é‡æ–°çµå¸³ã€‚');
        }

        amountPaid = paid;
        change = paid - total;
        alert(`å·²æ”¶ $${paid}ï¼Œæ‡‰æ‰¾é›¶ $${change}ã€‚`);
      }


      const body = {
        items: cart.map(i => i.name),
        total,
        payment: paymentType,
        txnId,
        change, // ğŸ†• æ–°å¢ 'change' æ¬„ä½
        // ğŸš¨ æ³¨æ„ï¼šApps Script çš„ doPost é æœŸæ”¶åˆ° total å’Œ paymentï¼Œ
        // ä½†æ²’æœ‰ amountPaid (å·²ä»˜é‡‘é¡) æ¬„ä½ï¼Œæ‰€ä»¥æˆ‘å€‘åªé€å‡º change
        // Apps Script ä¸­çš„ payment/total é‚è¼¯ä¸å—å½±éŸ¿
      };

      try {
        const res = await fetch(SHEET_URL, {
          method: 'POST',
          body: JSON.stringify(body),
          headers: { 'Content-Type': 'application/json' },
          mode: 'cors'
        });

        // âœ… Apps Script å›å‚³å…§å®¹å¯èƒ½ä¸æ˜¯ç´”æ–‡å­—ï¼Œéœ€æ˜ç¢ºè®€å–
        const text = await res.text();
        if (text.includes('OK')) {
          let successMessage = paymentType + ' çµå¸³æˆåŠŸï¼';
          if (paymentType === 'Cash') {
            successMessage += `\nå·²æ”¶ $${amountPaid}ï¼Œæ‰¾é›¶ $${change}ã€‚`;
          }
          alert(successMessage);
          cart = [];
          total = 0;
          renderCart();
        } else {
          alert('è³‡æ–™ä¸Šå‚³å¤±æ•—ï¼Œä¼ºæœå™¨å›å‚³ï¼š' + text);
        }
      } catch (err) {
        alert('âŒ ç¶²è·¯éŒ¯èª¤ï¼š' + err.message);
      }
    }

    document.getElementById('cashBtn').onclick = () => checkout('Cash');
    document.getElementById('linePayBtn').onclick = () => checkout('LINE Pay');
  </script>
</body>
</html>

